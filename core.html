<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Claudette’s source – claudette</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Claudette’s source – claudette">
<meta property="og:description" content="Claudette is Claude’s friend">
<meta property="og:site_name" content="claudette">
<meta name="twitter:title" content="Claudette’s source – claudette">
<meta name="twitter:description" content="Claudette is Claude’s friend">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">claudette</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">Claudette’s source</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">claudette</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Claudette’s source</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./toolloop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tool loop</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./async.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The async version</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#antropic-sdk" id="toc-antropic-sdk" class="nav-link" data-scroll-target="#antropic-sdk">Antropic SDK</a>
  <ul class="collapse">
  <li><a href="#formatting-output" id="toc-formatting-output" class="nav-link" data-scroll-target="#formatting-output">Formatting output</a></li>
  <li><a href="#find_block" id="toc-find_block" class="nav-link" data-scroll-target="#find_block">find_block</a></li>
  <li><a href="#contents" id="toc-contents" class="nav-link" data-scroll-target="#contents">contents</a></li>
  <li><a href="#usage" id="toc-usage" class="nav-link" data-scroll-target="#usage">usage</a></li>
  <li><a href="#usage.total" id="toc-usage.total" class="nav-link" data-scroll-target="#usage.total">Usage.total</a></li>
  <li><a href="#usage.__repr__" id="toc-usage.__repr__" class="nav-link" data-scroll-target="#usage.__repr__">Usage.__repr__</a></li>
  <li><a href="#usage.__add__" id="toc-usage.__add__" class="nav-link" data-scroll-target="#usage.__add__">Usage.__add__</a></li>
  <li><a href="#creating-messages" id="toc-creating-messages" class="nav-link" data-scroll-target="#creating-messages">Creating messages</a></li>
  <li><a href="#mk_msgs" id="toc-mk_msgs" class="nav-link" data-scroll-target="#mk_msgs">mk_msgs</a></li>
  </ul></li>
  <li><a href="#client" id="toc-client" class="nav-link" data-scroll-target="#client">Client</a>
  <ul class="collapse">
  <li><a href="#client-1" id="toc-client-1" class="nav-link" data-scroll-target="#client-1">Client</a></li>
  </ul></li>
  <li><a href="#tool-use" id="toc-tool-use" class="nav-link" data-scroll-target="#tool-use">Tool use</a>
  <ul class="collapse">
  <li><a href="#mk_tool_choice" id="toc-mk_tool_choice" class="nav-link" data-scroll-target="#mk_tool_choice">mk_tool_choice</a></li>
  <li><a href="#mk_funcres" id="toc-mk_funcres" class="nav-link" data-scroll-target="#mk_funcres">mk_funcres</a></li>
  <li><a href="#mk_toolres" id="toc-mk_toolres" class="nav-link" data-scroll-target="#mk_toolres">mk_toolres</a></li>
  <li><a href="#get_types" id="toc-get_types" class="nav-link" data-scroll-target="#get_types">get_types</a></li>
  <li><a href="#client.__call__" id="toc-client.__call__" class="nav-link" data-scroll-target="#client.__call__">Client.__call__</a></li>
  <li><a href="#client.structured" id="toc-client.structured" class="nav-link" data-scroll-target="#client.structured">Client.structured</a></li>
  </ul></li>
  <li><a href="#chat" id="toc-chat" class="nav-link" data-scroll-target="#chat">Chat</a>
  <ul class="collapse">
  <li><a href="#chat-1" id="toc-chat-1" class="nav-link" data-scroll-target="#chat-1">Chat</a></li>
  <li><a href="#usage.cost" id="toc-usage.cost" class="nav-link" data-scroll-target="#usage.cost">Usage.cost</a></li>
  <li><a href="#chat.cost" id="toc-chat.cost" class="nav-link" data-scroll-target="#chat.cost">Chat.cost</a></li>
  <li><a href="#chat.__call__" id="toc-chat.__call__" class="nav-link" data-scroll-target="#chat.__call__">Chat.__call__</a></li>
  <li><a href="#chat-tool-use" id="toc-chat-tool-use" class="nav-link" data-scroll-target="#chat-tool-use">Chat tool use</a></li>
  </ul></li>
  <li><a href="#images" id="toc-images" class="nav-link" data-scroll-target="#images">Images</a>
  <ul class="collapse">
  <li><a href="#img_msg" id="toc-img_msg" class="nav-link" data-scroll-target="#img_msg">img_msg</a></li>
  <li><a href="#text_msg" id="toc-text_msg" class="nav-link" data-scroll-target="#text_msg">text_msg</a></li>
  <li><a href="#mk_msg" id="toc-mk_msg" class="nav-link" data-scroll-target="#mk_msg">mk_msg</a></li>
  </ul></li>
  <li><a href="#third-party-providers" id="toc-third-party-providers" class="nav-link" data-scroll-target="#third-party-providers">Third party providers</a>
  <ul class="collapse">
  <li><a href="#amazon-bedrock" id="toc-amazon-bedrock" class="nav-link" data-scroll-target="#amazon-bedrock">Amazon Bedrock</a></li>
  <li><a href="#google-vertex" id="toc-google-vertex" class="nav-link" data-scroll-target="#google-vertex">Google Vertex</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/AnswerDotAI/claudette/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Claudette’s source</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>This is the ‘literate’ source code for Claudette. You can view the fully rendered version of the notebook <a href="https://claudette.answer.ai/core.html">here</a>, or you can clone the git repo and run the <a href="https://github.com/AnswerDotAI/claudette/blob/main/00_core.ipynb">interactive notebook</a> in Jupyter. The notebook is converted the <a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py">Python module claudette/core.py</a> using <a href="https://nbdev.fast.ai/">nbdev</a>. The goal of this source code is to both create the Python module, and also to teach the reader <em>how</em> it is created, without assuming much existing knowledge about Claude’s API.</p>
<p>Most of the time you’ll see that we write some source code <em>first</em>, and then a description or discussion of it <em>afterwards</em>.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="f1ad998e-4bb1-4bed-abf4-6e8606cb2453" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># os.environ['ANTHROPIC_LOG'] = 'debug'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To print every HTTP request and response in full, uncomment the above line. This functionality is provided by Anthropic’s SDK.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re reading the rendered version of this notebook, you’ll see an “Exported source” collapsible widget below. If you’re reading the source notebook directly, you’ll see <code>#| exports</code> at the top of the cell. These show that this piece of code will be exported into the python module that this notebook creates. No other code will be included – any other code in this notebook is just for demonstration, documentation, and testing.</p>
<p>You can toggle expanding/collapsing the source code of all exported sections by using the <code>&lt;/&gt; Code</code> menu in the top right of the rendered notebook page.</p>
</div>
</div>
<div id="0fff8869" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>model_types <span class="op">=</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Anthropic</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-opus-20240229'</span>: <span class="st">'opus'</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-5-sonnet-20241022'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-haiku-20240307'</span>: <span class="st">'haiku-3'</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-5-haiku-20241022'</span>: <span class="st">'haiku-3-5'</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AWS</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-3-opus-20240229-v1:0'</span>: <span class="st">'opus'</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-3-5-sonnet-20241022-v2:0'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-3-sonnet-20240229-v1:0'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'anthropic.claude-3-haiku-20240307-v1:0'</span>: <span class="st">'haiku'</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Google</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-opus@20240229'</span>: <span class="st">'opus'</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-5-sonnet-v2@20241022'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-sonnet@20240229'</span>: <span class="st">'sonnet'</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'claude-3-haiku@20240307'</span>: <span class="st">'haiku'</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>all_models <span class="op">=</span> <span class="bu">list</span>(model_types)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="669696aa" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>text_only_models <span class="op">=</span> (<span class="st">'claude-3-5-haiku-20241022'</span>,)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>These are the current versions and <a href="https://www.anthropic.com/pricing#anthropic-api">prices</a> of Anthropic’s models at the time of writing.</p>
<div id="dacf2bd2" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models[<span class="dv">1</span>]<span class="op">;</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'claude-3-5-sonnet-20241022'</code></pre>
</div>
</div>
<p>For examples, we’ll use Sonnet 3.5, since it’s awesome.</p>
</section>
<section id="antropic-sdk" class="level2">
<h2 class="anchored" data-anchor-id="antropic-sdk">Antropic SDK</h2>
<div id="70b53a51" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cli <span class="op">=</span> Anthropic()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is what Anthropic’s SDK provides for interacting with Python. To use it, pass it a list of <em>messages</em>, with <em>content</em> and a <em>role</em>. The roles should alternate between <em>user</em> and <em>assistant</em>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>After the code below you’ll see an indented section with an orange vertical line on the left. This is used to show the <em>result</em> of running the code above. Because the code is running in a Jupyter Notebook, we don’t have to use <code>print</code> to display results, we can just type the expression directly, as we do with <code>r</code> here.</p>
</div>
</div>
<div id="6ec40731" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> {<span class="st">'role'</span>: <span class="st">'user'</span>, <span class="st">'content'</span>: <span class="st">"I'm Jeremy"</span>}</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> cli.messages.create(messages<span class="op">=</span>[m], model<span class="op">=</span>model, max_tokens<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Jeremy! Nice to meet you. I’m Claude, an AI assistant. How can I help you today?</p>
<details>
<ul>
<li>id: <code>msg_017Q8WYvvANfyHWLJWt95UR1</code></li>
<li>content: <code>[{'text': "Hi Jeremy! Nice to meet you. I'm Claude, an AI assistant. How can I help you today?", 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 10, 'output_tokens': 27}</code></li>
</ul>
</details>
</div>
</div>
<section id="formatting-output" class="level3">
<h3 class="anchored" data-anchor-id="formatting-output">Formatting output</h3>
<p>That output is pretty long and hard to read, so let’s clean it up. We’ll start by pulling out the <code>Content</code> part of the message. To do that, we’re going to write our first function which will be included to the <code>claudette/core.py</code> module.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is the first exported public function or class we’re creating (the previous export was of a variable). In the rendered version of the notebook for these you’ll see 4 things, in this order (unless the symbol starts with a single <code>_</code>, which indicates it’s <em>private</em>):</p>
<ul>
<li>The signature (with the symbol name as a heading, with a horizontal rule above)</li>
<li>A table of paramater docs (if provided)</li>
<li>The doc string (in italics).</li>
<li>The source code (in a collapsible “Exported source” block)</li>
</ul>
<p>After that, we generally provide a bit more detail on what we’ve created, and why, along with a sample usage.</p>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L56" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="find_block" class="level3">
<h3 class="anchored" data-anchor-id="find_block">find_block</h3>
<blockquote class="blockquote">
<pre><code> find_block (r:collections.abc.Mapping, blk_type:type=&lt;class
             'anthropic.types.text_block.TextBlock'&gt;)</code></pre>
</blockquote>
<p><em>Find the first block of type <code>blk_type</code> in <code>r.content</code>.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>r</td>
<td>Mapping</td>
<td></td>
<td>The message to look in</td>
</tr>
<tr class="even">
<td>blk_type</td>
<td>type</td>
<td>TextBlock</td>
<td>The type of block to find</td>
</tr>
</tbody>
</table>
<div id="eba620ce" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_block(r:abc.Mapping, <span class="co"># The message to look in</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>               blk_type:<span class="bu">type</span><span class="op">=</span>TextBlock  <span class="co"># The type of block to find</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>              ):</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Find the first block of type `blk_type` in `r.content`."</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> first(o <span class="cf">for</span> o <span class="kw">in</span> r.content <span class="cf">if</span> <span class="bu">isinstance</span>(o,blk_type))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This makes it easier to grab the needed parts of Claude’s responses, which can include multiple pieces of content. By default, we look for the first text block. That will generally have the content we want to display.</p>
<div id="10af0e65" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>find_block(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>TextBlock(text="Hi Jeremy! Nice to meet you. I'm Claude, an AI assistant. How can I help you today?", type='text')</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L63" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="contents" class="level3">
<h3 class="anchored" data-anchor-id="contents">contents</h3>
<blockquote class="blockquote">
<pre><code> contents (r)</code></pre>
</blockquote>
<p><em>Helper to get the contents from Claude response <code>r</code>.</em></p>
<div id="ae99799d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contents(r):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to get the contents from Claude response `r`."</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    blk <span class="op">=</span> find_block(r)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> blk <span class="kw">and</span> r.content: blk <span class="op">=</span> r.content[<span class="dv">0</span>]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> blk.text.strip() <span class="cf">if</span> <span class="bu">hasattr</span>(blk,<span class="st">'text'</span>) <span class="cf">else</span> <span class="bu">str</span>(blk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For display purposes, we often just want to show the text itself.</p>
<div id="6d5f2107" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>contents(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>"Hi Jeremy! Nice to meet you. I'm Claude, an AI assistant. How can I help you today?"</code></pre>
</div>
</div>
<div id="17924d0c" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _repr_markdown_(<span class="va">self</span>:(Message)):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    det <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">- '</span>.join(<span class="ss">f'</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: `</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">`'</span> <span class="cf">for</span> k,v <span class="kw">in</span> <span class="va">self</span>.model_dump().items())</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    cts <span class="op">=</span> re.sub(<span class="vs">r'\$'</span>, <span class="st">'&amp;#36;'</span>, contents(<span class="va">self</span>))  <span class="co"># escape `$` for jupyter latex</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span><span class="sc">{</span>cts<span class="sc">}</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;details&gt;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="sc">{</span>det<span class="sc">}</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="ss">&lt;/details&gt;"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Jupyter looks for a <code>_repr_markdown_</code> method in displayed objects; we add this in order to display just the content text, and collapse full details into a hideable section. Note that <code>patch</code> is from <a href="https://fastcore.fast.ai/">fastcore</a>, and is used to add (or replace) functionality in an existing class. We pass the class(es) that we want to patch as type annotations to <code>self</code>. In this case, <code>_repr_markdown_</code> is being added to Anthropic’s <code>Message</code> class, so when we display the message now we just see the contents, and the details are hidden away in a collapsible details block.</p>
<div id="cfd85eeb" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Jeremy! Nice to meet you. I’m Claude, an AI assistant. How can I help you today?</p>
<details>
<ul>
<li>id: <code>msg_017Q8WYvvANfyHWLJWt95UR1</code></li>
<li>content: <code>[{'text': "Hi Jeremy! Nice to meet you. I'm Claude, an AI assistant. How can I help you today?", 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 10, 'output_tokens': 27}</code></li>
</ul>
</details>
</div>
</div>
<p>One key part of the response is the <a href="https://claudette.answer.ai/core.html#usage"><code>usage</code></a> key, which tells us how many tokens we used by returning a <code>Usage</code> object.</p>
<p>We’ll add some helpers to make things a bit cleaner for creating and formatting these objects.</p>
<div id="10c7466f" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>r.usage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 10; Out: 27; Cache create: 0; Cache read: 0; Total: 37</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L83" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage" class="level3">
<h3 class="anchored" data-anchor-id="usage">usage</h3>
<blockquote class="blockquote">
<pre><code> usage (inp=0, out=0, cache_create=0, cache_read=0)</code></pre>
</blockquote>
<p><em>Slightly more concise version of <code>Usage</code>.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>inp</td>
<td>int</td>
<td>0</td>
<td>input tokens</td>
</tr>
<tr class="even">
<td>out</td>
<td>int</td>
<td>0</td>
<td>Output tokens</td>
</tr>
<tr class="odd">
<td>cache_create</td>
<td>int</td>
<td>0</td>
<td>Cache creation tokens</td>
</tr>
<tr class="even">
<td>cache_read</td>
<td>int</td>
<td>0</td>
<td>Cache read tokens</td>
</tr>
</tbody>
</table>
<div id="b1a24f68" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> usage(inp<span class="op">=</span><span class="dv">0</span>, <span class="co"># input tokens</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>          out<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Output tokens</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>          cache_create<span class="op">=</span><span class="dv">0</span>, <span class="co"># Cache creation tokens</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>          cache_read<span class="op">=</span><span class="dv">0</span> <span class="co"># Cache read tokens</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>         ):</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Slightly more concise version of `Usage`."</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Usage(input_tokens<span class="op">=</span>inp, output_tokens<span class="op">=</span>out, cache_creation_input_tokens<span class="op">=</span>cache_create, cache_read_input_tokens<span class="op">=</span>cache_read)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The constructor provided by Anthropic is rather verbose, so we clean it up a bit, using a lowercase version of the name.</p>
<div id="a7e52afd" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>usage(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 5; Out: 0; Cache create: 0; Cache read: 0; Total: 5</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L93" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage.total" class="level3">
<h3 class="anchored" data-anchor-id="usage.total">Usage.total</h3>
<blockquote class="blockquote">
<pre><code> Usage.total ()</code></pre>
</blockquote>
<div id="2db64da5" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> total(<span class="va">self</span>:Usage): <span class="cf">return</span> <span class="va">self</span>.input_tokens<span class="op">+</span><span class="va">self</span>.output_tokens<span class="op">+</span><span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"cache_creation_input_tokens"</span>,<span class="dv">0</span>)<span class="op">+</span><span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"cache_read_input_tokens"</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Adding a <code>total</code> property to <code>Usage</code> makes it easier to see how many tokens we’ve used up altogether.</p>
<div id="74553203" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>usage(<span class="dv">5</span>,<span class="dv">1</span>).total</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>6</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L97" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage.__repr__" class="level3">
<h3 class="anchored" data-anchor-id="usage.__repr__">Usage.__repr__</h3>
<blockquote class="blockquote">
<pre><code> Usage.__repr__ ()</code></pre>
</blockquote>
<p><em>Return repr(self).</em></p>
<div id="27468180" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>:Usage): <span class="cf">return</span> <span class="ss">f'In: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>input_tokens<span class="sc">}</span><span class="ss">; Out: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>output_tokens<span class="sc">}</span><span class="ss">; Cache create: </span><span class="sc">{</span><span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"cache_creation_input_tokens"</span>,<span class="dv">0</span>)<span class="sc">}</span><span class="ss">; Cache read: </span><span class="sc">{</span><span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"cache_read_input_tokens"</span>,<span class="dv">0</span>)<span class="sc">}</span><span class="ss">; Total: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>total<span class="sc">}</span><span class="ss">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In python, patching <code>__repr__</code> lets us change how an object is displayed. (More generally, methods starting and ending in <code>__</code> in Python are called <code>dunder</code> methods, and have some <code>magic</code> behavior – such as, in this case, changing how an object is displayed.)</p>
<div id="b8af5068" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>usage(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 5; Out: 0; Cache create: 0; Cache read: 0; Total: 5</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L101" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage.__add__" class="level3">
<h3 class="anchored" data-anchor-id="usage.__add__">Usage.__add__</h3>
<blockquote class="blockquote">
<pre><code> Usage.__add__ (b)</code></pre>
</blockquote>
<p><em>Add together each of <code>input_tokens</code> and <code>output_tokens</code></em></p>
<div id="bec303ba" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>:Usage, b):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add together each of `input_tokens` and `output_tokens`"</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> usage(<span class="va">self</span>.input_tokens<span class="op">+</span>b.input_tokens, <span class="va">self</span>.output_tokens<span class="op">+</span>b.output_tokens, <span class="bu">getattr</span>(<span class="va">self</span>,<span class="st">'cache_creation_input_tokens'</span>,<span class="dv">0</span>)<span class="op">+</span><span class="bu">getattr</span>(b,<span class="st">'cache_creation_input_tokens'</span>,<span class="dv">0</span>), <span class="bu">getattr</span>(<span class="va">self</span>,<span class="st">'cache_read_input_tokens'</span>,<span class="dv">0</span>)<span class="op">+</span><span class="bu">getattr</span>(b,<span class="st">'cache_read_input_tokens'</span>,<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And, patching <code>__add__</code> lets <code>+</code> work on a <code>Usage</code> object.</p>
<div id="bffb0b2e" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>r.usage<span class="op">+</span>r.usage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 20; Out: 54; Cache create: 0; Cache read: 0; Total: 74</code></pre>
</div>
</div>
</section>
<section id="creating-messages" class="level3">
<h3 class="anchored" data-anchor-id="creating-messages">Creating messages</h3>
<p>Creating correctly formatted <code>dict</code>s from scratch every time isn’t very handy, so next up we’ll add helpers for this.</p>
<div id="4f3e4de9" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msg(content, role<span class="op">=</span><span class="st">'user'</span>, <span class="op">**</span>kw):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(role<span class="op">=</span>role, content<span class="op">=</span>content, <span class="op">**</span>kw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We make things a bit more convenient by writing a function to create a message for us.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may have noticed that we didn’t export the <a href="https://claudette.answer.ai/core.html#mk_msg"><code>mk_msg</code></a> function (i.e.&nbsp;there’s no “Exported source” block around it). That’s because we’ll need more functionality in our final version than this version has – so we’ll be defining a more complete version later. Rather than refactoring/editing in notebooks, often it’s helpful to simply gradually build up complexity by re-defining a symbol.</p>
</div>
</div>
<div id="28542783" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"I'm Jeremy"</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> mk_msg(prompt)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'role': 'user', 'content': "I'm Jeremy"}</code></pre>
</div>
</div>
<div id="9ba165ff" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> cli.messages.create(messages<span class="op">=</span>[m], model<span class="op">=</span>model, max_tokens<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hi Jeremy! I’m Claude. Nice to meet you. How can I help you today?</p>
<details>
<ul>
<li>id: <code>msg_01BhkuvQtEPoC8wHSbU7YRpV</code></li>
<li>content: <code>[{'text': "Hi Jeremy! I'm Claude. Nice to meet you. How can I help you today?", 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 10, 'output_tokens': 24}</code></li>
</ul>
</details>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L106" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msgs" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs">mk_msgs</h3>
<blockquote class="blockquote">
<pre><code> mk_msgs (msgs:list, **kw)</code></pre>
</blockquote>
<p><em>Helper to set ‘assistant’ role on alternate messages.</em></p>
<div id="8cfb240d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msgs(msgs:<span class="bu">list</span>, <span class="op">**</span>kw):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to set 'assistant' role on alternate messages."</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(msgs,<span class="bu">str</span>): msgs<span class="op">=</span>[msgs]</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [mk_msg(o, (<span class="st">'user'</span>,<span class="st">'assistant'</span>)[i<span class="op">%</span><span class="dv">2</span>], <span class="op">**</span>kw) <span class="cf">for</span> i,o <span class="kw">in</span> <span class="bu">enumerate</span>(msgs)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>LLMs, including Claude, don’t actually have state, but instead dialogs are created by passing back all previous prompts and responses every time. With Claude, they always alternate <em>user</em> and <em>assistant</em>. Therefore we create a function to make it easier to build up these dialog lists.</p>
<p>But to do so, we need to update <a href="https://claudette.answer.ai/core.html#mk_msg"><code>mk_msg</code></a> so that we can’t only pass a <code>str</code> as <code>content</code>, but can also pass a <code>dict</code> or an object with a <code>content</code> attr, since these are both types of message that Claude can create. To do so, we check for a <code>content</code> key or attr, and use it if found.</p>
<div id="83b63276" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _str_if_needed(o):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(o, (<span class="bu">list</span>,<span class="bu">tuple</span>,abc.Mapping,L)) <span class="kw">or</span> <span class="bu">hasattr</span>(o, <span class="st">'__pydantic_serializer__'</span>): <span class="cf">return</span> o</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">str</span>(o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="8ab553a4" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msg(content, role<span class="op">=</span><span class="st">'user'</span>, <span class="op">**</span>kw):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to create a `dict` appropriate for a Claude message. `kw` are added as key/value pairs to the message"</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(content, <span class="st">'content'</span>): content,role <span class="op">=</span> content.content,content.role</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(content, abc.Mapping): content<span class="op">=</span>content[<span class="st">'content'</span>]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(role<span class="op">=</span>role, content<span class="op">=</span>_str_if_needed(content), <span class="op">**</span>kw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7eef3715" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs([prompt, r, <span class="st">'I forgot my name. Can you remind me please?'</span>])</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': "I'm Jeremy"},
 {'role': 'assistant',
  'content': [TextBlock(text="Hi Jeremy! I'm Claude. Nice to meet you. How can I help you today?", type='text')]},
 {'role': 'user', 'content': 'I forgot my name. Can you remind me please?'}]</code></pre>
</div>
</div>
<p>Now, if we pass this list of messages to Claude, the model treats it as a conversation to respond to.</p>
<div id="6c464f8b" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>cli.messages.create(messages<span class="op">=</span>msgs, model<span class="op">=</span>model, max_tokens<span class="op">=</span><span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>You just told me your name is Jeremy.</p>
<details>
<ul>
<li>id: <code>msg_01KZski1R3z1iGjF6XsBb9dM</code></li>
<li>content: <code>[{'text': 'You just told me your name is Jeremy.', 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 46, 'output_tokens': 13}</code></li>
</ul>
</details>
</div>
</div>
</section>
</section>
<section id="client" class="level2">
<h2 class="anchored" data-anchor-id="client">Client</h2>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L117" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="client-1" class="level3">
<h3 class="anchored" data-anchor-id="client-1">Client</h3>
<blockquote class="blockquote">
<pre><code> Client (model, cli=None, log=False)</code></pre>
</blockquote>
<p><em>Basic Anthropic messages client.</em></p>
<div id="3b873aaf" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Client:</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, cli<span class="op">=</span><span class="va">None</span>, log<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Basic Anthropic messages client."</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model,<span class="va">self</span>.use <span class="op">=</span> model,usage()</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.text_only <span class="op">=</span> model <span class="kw">in</span> text_only_models</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log <span class="op">=</span> [] <span class="cf">if</span> log <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.c <span class="op">=</span> (cli <span class="kw">or</span> Anthropic(default_headers<span class="op">=</span>{<span class="st">'anthropic-beta'</span>: <span class="st">'prompt-caching-2024-07-31'</span>}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We’ll create a simple <a href="https://claudette.answer.ai/core.html#client"><code>Client</code></a> for <code>Anthropic</code> which tracks usage stores the model to use. We don’t add any methods right away – instead we’ll use <code>patch</code> for that so we can add and document them incrementally.</p>
<div id="d01e9ccf" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Client(model)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 0; Out: 0; Cache create: 0; Cache read: 0; Total: 0</code></pre>
</div>
</div>
<div id="8015d3f3" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _r(<span class="va">self</span>:Client, r:Message, prefill<span class="op">=</span><span class="st">''</span>):</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Store the result of the message and accrue total usage."</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prefill:</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        blk <span class="op">=</span> find_block(r)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        blk.text <span class="op">=</span> prefill <span class="op">+</span> (blk.text <span class="kw">or</span> <span class="st">''</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.result <span class="op">=</span> r</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.use <span class="op">+=</span> r.usage</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.stop_reason <span class="op">=</span> r.stop_reason</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.stop_sequence <span class="op">=</span> r.stop_sequence</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We use a <code>_</code> prefix on private methods, but we document them here in the interests of literate source code.</p>
<p><code>_r</code> will be used each time we get a new result, to track usage and also to keep the result available for later.</p>
<div id="0181f7b3" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>c._r(r)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 10; Out: 24; Cache create: 0; Cache read: 0; Total: 34</code></pre>
</div>
</div>
<p>Whereas OpenAI’s models use a <code>stream</code> parameter for streaming, Anthropic’s use a separate method. We implement Anthropic’s approach in a private method, and then use a <code>stream</code> parameter in <code>__call__</code> for consistency:</p>
<div id="6520a355" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _log(<span class="va">self</span>:Client, final, prefill, msgs, maxtok<span class="op">=</span><span class="va">None</span>, sp<span class="op">=</span><span class="va">None</span>, temp<span class="op">=</span><span class="va">None</span>, stream<span class="op">=</span><span class="va">None</span>, stop<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._r(final, prefill)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.log <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: <span class="va">self</span>.log.append({</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"msgs"</span>: msgs, <span class="st">"prefill"</span>: prefill, <span class="op">**</span>kwargs,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"msgs"</span>: msgs, <span class="st">"prefill"</span>: prefill, <span class="st">"maxtok"</span>: maxtok, <span class="st">"sp"</span>: sp, <span class="st">"temp"</span>: temp, <span class="st">"stream"</span>: stream, <span class="st">"stop"</span>: stop, <span class="op">**</span>kwargs,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"result"</span>: <span class="va">self</span>.result, <span class="st">"use"</span>: <span class="va">self</span>.use, <span class="st">"stop_reason"</span>: <span class="va">self</span>.stop_reason, <span class="st">"stop_sequence"</span>: <span class="va">self</span>.stop_sequence</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="6901dce2" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _stream(<span class="va">self</span>:Client, msgs:<span class="bu">list</span>, prefill<span class="op">=</span><span class="st">''</span>, <span class="op">**</span>kwargs):</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="va">self</span>.c.messages.stream(model<span class="op">=</span><span class="va">self</span>.model, messages<span class="op">=</span>mk_msgs(msgs), <span class="op">**</span>kwargs) <span class="im">as</span> s:</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prefill: <span class="cf">yield</span>(prefill)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> <span class="cf">from</span> s.text_stream</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._log(s.get_final_message(), prefill, msgs, <span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Claude supports adding an extra <code>assistant</code> message at the end, which contains the <em>prefill</em> – i.e.&nbsp;the text we want Claude to assume the response starts with. However Claude doesn’t actually repeat that in the response, so for convenience we add it.</p>
<div id="835638bb" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _precall(<span class="va">self</span>:Client, msgs, prefill, stop, kwargs):</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    pref <span class="op">=</span> [prefill.strip()] <span class="cf">if</span> prefill <span class="cf">else</span> []</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(msgs,<span class="bu">list</span>): msgs <span class="op">=</span> [msgs]</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stop <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(stop, (<span class="bu">list</span>)): stop <span class="op">=</span> [stop]</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        kwargs[<span class="st">"stop_sequences"</span>] <span class="op">=</span> stop</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    msgs <span class="op">=</span> mk_msgs(msgs<span class="op">+</span>pref)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="c21c2113" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(messages.Messages.create)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>:Client,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>             msgs:<span class="bu">list</span>, <span class="co"># List of messages in the dialog</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>             sp<span class="op">=</span><span class="st">''</span>, <span class="co"># The system prompt</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>             temp<span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>             maxtok<span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>             prefill<span class="op">=</span><span class="st">''</span>, <span class="co"># Optional prefill to pass to Claude as start of its response</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>             stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>             stop<span class="op">=</span><span class="va">None</span>, <span class="co"># Stop sequence</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>             <span class="op">**</span>kwargs):</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Make a call to Claude."</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    msgs <span class="op">=</span> <span class="va">self</span>._precall(msgs, prefill, stop, kwargs)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stream: <span class="cf">return</span> <span class="va">self</span>._stream(msgs, prefill<span class="op">=</span>prefill, max_tokens<span class="op">=</span>maxtok, system<span class="op">=</span>sp, temperature<span class="op">=</span>temp, <span class="op">**</span>kwargs)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="va">self</span>.c.messages.create(</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span><span class="va">self</span>.model, messages<span class="op">=</span>msgs, max_tokens<span class="op">=</span>maxtok, system<span class="op">=</span>sp, temperature<span class="op">=</span>temp, <span class="op">**</span>kwargs)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>._log(res, prefill, msgs, maxtok, sp, temp, stream<span class="op">=</span>stream, <span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Defining <code>__call__</code> let’s us use an object like a function (i.e it’s <em>callable</em>). We use it as a small wrapper over <code>messages.create</code>. However we’re not exporting this version just yet – we have some additions we’ll make in a moment…</p>
<div id="881b5e78" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Client(model, log<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 0; Out: 0; Cache create: 0; Cache read: 0; Total: 0</code></pre>
</div>
</div>
<div id="338a38e5" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>c(<span class="st">'Hi'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Hello! How can I help you today?</p>
<details>
<ul>
<li>id: <code>msg_01DZfHpTqbodjegmvG6kkQvn</code></li>
<li>content: <code>[{'text': 'Hello! How can I help you today?', 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 8, 'output_tokens': 22, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<div id="ae9f7e06" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 8; Out: 22; Cache create: 0; Cache read: 0; Total: 30</code></pre>
</div>
</div>
<p>Let’s try out <em>prefill</em>:</p>
<div id="7f479429" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> <span class="st">"Concisely, what is the meaning of life?"</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>pref <span class="op">=</span> <span class="st">'According to Douglas Adams,'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b831ca3d" class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>c(q, prefill<span class="op">=</span>pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>According to Douglas Adams, it’s 42. More seriously, there’s no universal answer - it’s deeply personal. Common perspectives include: finding happiness, making meaningful connections, pursuing purpose through work/creativity, helping others, or simply experiencing and appreciating existence.</p>
<details>
<ul>
<li>id: <code>msg_01RKAjFBMhyBjvKw59ypM6tp</code></li>
<li>content: <code>[{'text': "According to Douglas Adams,  it's 42. More seriously, there's no universal answer - it's deeply personal. Common perspectives include: finding happiness, making meaningful connections, pursuing purpose through work/creativity, helping others, or simply experiencing and appreciating existence.", 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 24, 'output_tokens': 53, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<p>We can pass <code>stream=True</code> to stream the response back incrementally:</p>
<div id="e281399f" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> c(<span class="st">'Hi'</span>, stream<span class="op">=</span><span class="va">True</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hello! How can I help you today?</code></pre>
</div>
</div>
<div id="beb25f2a" class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 40; Out: 97; Cache create: 0; Cache read: 0; Total: 137</code></pre>
</div>
</div>
<div id="db1c75ef" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> c(q, prefill<span class="op">=</span>pref, stream<span class="op">=</span><span class="va">True</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>According to Douglas Adams,  it's 42. More seriously, there's no universal answer - it's deeply personal. Common perspectives include: finding happiness, making meaningful connections, pursuing purpose through work/creativity, helping others, or simply experiencing and appreciating existence.</code></pre>
</div>
</div>
<div id="e36eddc9" class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>In: 64; Out: 150; Cache create: 0; Cache read: 0; Total: 214</code></pre>
</div>
</div>
<p>Pass a stop seauence if you want claude to stop generating text when it encounters it.</p>
<div id="12b17591" class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>c(<span class="st">"Count from 1 to 10"</span>, stop<span class="op">=</span><span class="st">"5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>1 2 3 4</p>
<details>
<ul>
<li>id: <code>msg_01D3kdCAHNbXadE144FLPbQV</code></li>
<li>content: <code>[{'text': '1\n2\n3\n4\n', 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>stop_sequence</code></li>
<li>stop_sequence: <code>5</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 15, 'output_tokens': 11, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<p>This also works with streaming, and you can pass more than one stop sequence:</p>
<div id="ff50577d" class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> c(<span class="st">"Count from 1 to 10"</span>, stop<span class="op">=</span>[<span class="st">"2"</span>, <span class="st">"yellow"</span>], stream<span class="op">=</span><span class="va">True</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(c.stop_reason, c.stop_sequence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1
stop_sequence 2</code></pre>
</div>
</div>
<p>You can check the logs:</p>
<div id="17122b92" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>c.log[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'msgs': [{'role': 'user', 'content': 'Count from 1 to 10'}],
 'prefill': '',
 'max_tokens': 4096,
 'system': '',
 'temperature': 0,
 'stop_sequences': ['2', 'yellow'],
 'maxtok': None,
 'sp': None,
 'temp': None,
 'stream': None,
 'stop': None,
 'result': Message(id='msg_01PbJN7QLwYALfoqTtYJHYVR', content=[TextBlock(text='1\n', type='text')], model='claude-3-5-sonnet-20241022', role='assistant', stop_reason='stop_sequence', stop_sequence='2', type='message', usage=In: 15; Out: 11; Cache create: 0; Cache read: 0; Total: 26),
 'use': In: 94; Out: 172; Cache create: 0; Cache read: 0; Total: 266,
 'stop_reason': 'stop_sequence',
 'stop_sequence': '2'}</code></pre>
</div>
</div>
</section>
</section>
<section id="tool-use" class="level2">
<h2 class="anchored" data-anchor-id="tool-use">Tool use</h2>
<p>Let’s now add tool use (aka <em>function calling</em>).</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L169" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="mk_tool_choice" class="level3">
<h3 class="anchored" data-anchor-id="mk_tool_choice">mk_tool_choice</h3>
<blockquote class="blockquote">
<pre><code> mk_tool_choice (choose:Union[str,bool,NoneType])</code></pre>
</blockquote>
<p><em>Create a <code>tool_choice</code> dict that’s ‘auto’ if <code>choose</code> is <code>None</code>, ‘any’ if it is True, or ‘tool’ otherwise</em></p>
<div id="01e3e2af" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_tool_choice(choose:Union[<span class="bu">str</span>,<span class="bu">bool</span>,<span class="va">None</span>])<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create a `tool_choice` dict that's 'auto' if `choose` is `None`, 'any' if it is True, or 'tool' otherwise"</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"type"</span>: <span class="st">"tool"</span>, <span class="st">"name"</span>: choose} <span class="cf">if</span> <span class="bu">isinstance</span>(choose,<span class="bu">str</span>) <span class="cf">else</span> {<span class="st">'type'</span>:<span class="st">'any'</span>} <span class="cf">if</span> choose <span class="cf">else</span> {<span class="st">'type'</span>:<span class="st">'auto'</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="753c4cd5" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mk_tool_choice(<span class="st">'sums'</span>))</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mk_tool_choice(<span class="va">True</span>))</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mk_tool_choice(<span class="va">None</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'type': 'tool', 'name': 'sums'}
{'type': 'any'}
{'type': 'auto'}</code></pre>
</div>
</div>
<p>Claude can be forced to use a particular tool, or select from a specific list of tools, or decide for itself when to use a tool. If you want to force a tool (or force choosing from a list), include a <code>tool_choice</code> param with a dict from <a href="https://claudette.answer.ai/core.html#mk_tool_choice"><code>mk_tool_choice</code></a>.</p>
<p>For testing, we need a function that Claude can call; we’ll write a simple function that adds numbers together, and will tell us when it’s being called:</p>
<div id="046e8cc3" class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sums(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    a:<span class="bu">int</span>,  <span class="co"># First thing to sum</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    b:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span> <span class="co"># Second thing to sum</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">int</span>: <span class="co"># The sum of the inputs</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Adds a + b."</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Finding the sum of </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d51f2bdf" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>a,b <span class="op">=</span> <span class="dv">604542</span>,<span class="dv">6458932</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?"</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"You are a summing expert."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Claudette can autogenerate a schema thanks to the <code>toolslm</code> library. We’ll force the use of the tool using the function we created earlier.</p>
<div id="bff81d52" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>tools<span class="op">=</span>[get_schema(sums)]</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>choice <span class="op">=</span> mk_tool_choice(<span class="st">'sums'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll start a dialog with Claude now. We’ll store the messages of our dialog in <code>msgs</code>. The first message will be our prompt <code>pr</code>, and we’ll pass our <code>tools</code> schema.</p>
<div id="c2ceeb75" class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> mk_msgs(pr)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(msgs, sp<span class="op">=</span>sp, tools<span class="op">=</span>tools, tool_choice<span class="op">=</span>choice)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ToolUseBlock(id=‘toolu_01JEJNPyeeGm7uwckeF5J4pf’, input={‘a’: 604542, ‘b’: 6458932}, name=‘sums’, type=‘tool_use’)</p>
<details>
<ul>
<li>id: <code>msg_015eEr2H8V4j8nNEh1KQifjH</code></li>
<li>content: <code>[{'id': 'toolu_01JEJNPyeeGm7uwckeF5J4pf', 'input': {'a': 604542, 'b': 6458932}, 'name': 'sums', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 442, 'output_tokens': 55, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<p>When Claude decides that it should use a tool, it passes back a <code>ToolUseBlock</code> with the name of the tool to call, and the params to use.</p>
<p>We don’t want to allow it to call just any possible function (that would be a security disaster!) so we create a <em>namespace</em> – that is, a dictionary of allowable function names to call.</p>
<div id="4fb9826f" class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>ns <span class="op">=</span> mk_ns(sums)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>ns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'sums': &lt;function __main__.sums(a: int, b: int = 1) -&gt; int&gt;}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L174" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_funcres" class="level3">
<h3 class="anchored" data-anchor-id="mk_funcres">mk_funcres</h3>
<blockquote class="blockquote">
<pre><code> mk_funcres (tuid, res)</code></pre>
</blockquote>
<p><em>Given tool use id and the tool result, create a tool_result response.</em></p>
<div id="5a7728ff" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_funcres(tuid, res):</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Given tool use id and the tool result, create a tool_result response."</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">type</span><span class="op">=</span><span class="st">"tool_result"</span>, tool_use_id<span class="op">=</span>tuid, content<span class="op">=</span><span class="bu">str</span>(res))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can now use the function requested by Claude. We look it up in <code>ns</code>, and pass in the provided parameters.</p>
<div id="893f81ca" class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>fc <span class="op">=</span> find_block(r, ToolUseBlock)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> mk_funcres(fc.<span class="bu">id</span>, call_func(fc.name, fc.<span class="bu">input</span>, ns<span class="op">=</span>ns))</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'type': 'tool_result',
 'tool_use_id': 'toolu_01JEJNPyeeGm7uwckeF5J4pf',
 'content': '7063474'}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L179" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_toolres" class="level3">
<h3 class="anchored" data-anchor-id="mk_toolres">mk_toolres</h3>
<blockquote class="blockquote">
<pre><code> mk_toolres (r:collections.abc.Mapping,
             ns:Optional[collections.abc.Mapping]=None, obj:Optional=None)</code></pre>
</blockquote>
<p><em>Create a <code>tool_result</code> message from response <code>r</code>.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>r</td>
<td>Mapping</td>
<td></td>
<td>Tool use request response from Claude</td>
</tr>
<tr class="even">
<td>ns</td>
<td>Optional</td>
<td>None</td>
<td>Namespace to search for tools</td>
</tr>
<tr class="odd">
<td>obj</td>
<td>Optional</td>
<td>None</td>
<td>Class to search for tools</td>
</tr>
</tbody>
</table>
<div id="d475922d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_toolres(</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    r:abc.Mapping, <span class="co"># Tool use request response from Claude</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    ns:Optional[abc.Mapping]<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    obj:Optional<span class="op">=</span><span class="va">None</span> <span class="co"># Class to search for tools</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create a `tool_result` message from response `r`."</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    cts <span class="op">=</span> <span class="bu">getattr</span>(r, <span class="st">'content'</span>, [])</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> [mk_msg(r)]</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ns <span class="kw">is</span> <span class="va">None</span>: ns<span class="op">=</span><span class="bu">globals</span>()</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> obj <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: ns <span class="op">=</span> mk_ns(obj)</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>    tcs <span class="op">=</span> [mk_funcres(o.<span class="bu">id</span>, call_func(o.name, o.<span class="bu">input</span>, ns)) <span class="cf">for</span> o <span class="kw">in</span> cts <span class="cf">if</span> <span class="bu">isinstance</span>(o,ToolUseBlock)]</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tcs: res.append(mk_msg(tcs))</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In order to tell Claude the result of the tool call, we pass back the tool use assistant request and the <code>tool_result</code> response.</p>
<div id="f13de1fc" class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, ns<span class="op">=</span>ns)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>tr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'assistant',
  'content': [ToolUseBlock(id='toolu_01JEJNPyeeGm7uwckeF5J4pf', input={'a': 604542, 'b': 6458932}, name='sums', type='tool_use')]},
 {'role': 'user',
  'content': [{'type': 'tool_result',
    'tool_use_id': 'toolu_01JEJNPyeeGm7uwckeF5J4pf',
    'content': '7063474'}]}]</code></pre>
</div>
</div>
<p>We add this to our dialog, and now Claude has all the information it needs to answer our question.</p>
<div id="eed99502" class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">+=</span> tr</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>contents(c(msgs, sp<span class="op">=</span>sp, tools<span class="op">=</span>tools))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'The sum of 604542 and 6458932 is 7063474.'</code></pre>
</div>
</div>
<div id="8fc252dc" class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user', 'content': 'What is 604542+6458932?'},
 {'role': 'assistant',
  'content': [ToolUseBlock(id='toolu_01JEJNPyeeGm7uwckeF5J4pf', input={'a': 604542, 'b': 6458932}, name='sums', type='tool_use')]},
 {'role': 'user',
  'content': [{'type': 'tool_result',
    'tool_use_id': 'toolu_01JEJNPyeeGm7uwckeF5J4pf',
    'content': '7063474'}]}]</code></pre>
</div>
</div>
<p>This works with methods as well – in this case, use the object itself for <code>ns</code>:</p>
<div id="800a53a9" class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dummy:</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sums(</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>        a:<span class="bu">int</span>,  <span class="co"># First thing to sum</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>        b:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span> <span class="co"># Second thing to sum</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">int</span>: <span class="co"># The sum of the inputs</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Adds a + b."</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Finding the sum of </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a <span class="op">+</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b21e6290" class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>tools <span class="op">=</span> [get_schema(Dummy.sums)]</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>o <span class="op">=</span> Dummy()</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(pr, sp<span class="op">=</span>sp, tools<span class="op">=</span>tools, tool_choice<span class="op">=</span>choice)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, obj<span class="op">=</span>o)</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">+=</span> tr</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>contents(c(msgs, sp<span class="op">=</span>sp, tools<span class="op">=</span>tools))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>'The sum of 604542 and 6458932 is 7063474.'</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L194" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_types" class="level3">
<h3 class="anchored" data-anchor-id="get_types">get_types</h3>
<blockquote class="blockquote">
<pre><code> get_types (msgs)</code></pre>
</blockquote>
<div id="6260d227" class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>get_types(msgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['text', 'tool_use', 'tool_result', 'tool_use', 'tool_result']</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L205" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="client.__call__" class="level3">
<h3 class="anchored" data-anchor-id="client.__call__">Client.__call__</h3>
<blockquote class="blockquote">
<pre><code> Client.__call__ (msgs:list, sp='', temp=0, maxtok=4096, prefill='',
                  stream:bool=False, stop=None, tools:Optional[list]=None,
                  tool_choice:Optional[dict]=None,
                  metadata:MetadataParam|NotGiven=NOT_GIVEN,
                  stop_sequences:List[str]|NotGiven=NOT_GIVEN, system:Unio
                  n[str,Iterable[TextBlockParam]]|NotGiven=NOT_GIVEN,
                  temperature:float|NotGiven=NOT_GIVEN,
                  top_k:int|NotGiven=NOT_GIVEN,
                  top_p:float|NotGiven=NOT_GIVEN,
                  extra_headers:Headers|None=None,
                  extra_query:Query|None=None, extra_body:Body|None=None,
                  timeout:float|httpx.Timeout|None|NotGiven=NOT_GIVEN)</code></pre>
</blockquote>
<p><em>Make a call to Claude.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>msgs</td>
<td>list</td>
<td></td>
<td>List of messages in the dialog</td>
</tr>
<tr class="even">
<td>sp</td>
<td>str</td>
<td></td>
<td>The system prompt</td>
</tr>
<tr class="odd">
<td>temp</td>
<td>int</td>
<td>0</td>
<td>Temperature</td>
</tr>
<tr class="even">
<td>maxtok</td>
<td>int</td>
<td>4096</td>
<td>Maximum tokens</td>
</tr>
<tr class="odd">
<td>prefill</td>
<td>str</td>
<td></td>
<td>Optional prefill to pass to Claude as start of its response</td>
</tr>
<tr class="even">
<td>stream</td>
<td>bool</td>
<td>False</td>
<td>Stream response?</td>
</tr>
<tr class="odd">
<td>stop</td>
<td>NoneType</td>
<td>None</td>
<td>Stop sequence</td>
</tr>
<tr class="even">
<td>tools</td>
<td>Optional</td>
<td>None</td>
<td>List of tools to make available to Claude</td>
</tr>
<tr class="odd">
<td>tool_choice</td>
<td>Optional</td>
<td>None</td>
<td>Optionally force use of some tool</td>
</tr>
<tr class="even">
<td>metadata</td>
<td>MetadataParam | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="odd">
<td>stop_sequences</td>
<td>List[str] | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="even">
<td>system</td>
<td>Union[str, Iterable[TextBlockParam]] | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="odd">
<td>temperature</td>
<td>float | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="even">
<td>top_k</td>
<td>int | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="odd">
<td>top_p</td>
<td>float | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="even">
<td>extra_headers</td>
<td>Headers | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>extra_query</td>
<td>Query | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>extra_body</td>
<td>Body | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>timeout</td>
<td>float | httpx.Timeout | None | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
</tbody>
</table>
<div id="73279877" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(messages.Messages.create)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>:Client,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>             msgs:<span class="bu">list</span>, <span class="co"># List of messages in the dialog</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>             sp<span class="op">=</span><span class="st">''</span>, <span class="co"># The system prompt</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>             temp<span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>             maxtok<span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>             prefill<span class="op">=</span><span class="st">''</span>, <span class="co"># Optional prefill to pass to Claude as start of its response</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>             stream:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>             stop<span class="op">=</span><span class="va">None</span>, <span class="co"># Stop sequence</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>             tools:Optional[<span class="bu">list</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># List of tools to make available to Claude</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>             tool_choice:Optional[<span class="bu">dict</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># Optionally force use of some tool</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>             <span class="op">**</span>kwargs):</span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Make a call to Claude."</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tools: kwargs[<span class="st">'tools'</span>] <span class="op">=</span> [get_schema(o) <span class="cf">for</span> o <span class="kw">in</span> listify(tools)]</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tool_choice: kwargs[<span class="st">'tool_choice'</span>] <span class="op">=</span> mk_tool_choice(tool_choice)</span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>    msgs <span class="op">=</span> <span class="va">self</span>._precall(msgs, prefill, stop, kwargs)</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(t <span class="op">==</span> <span class="st">'image'</span> <span class="cf">for</span> t <span class="kw">in</span> get_types(msgs)): <span class="cf">assert</span> <span class="kw">not</span> <span class="va">self</span>.text_only, <span class="ss">f"Images are not supported by the current model type: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>model<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stream: <span class="cf">return</span> <span class="va">self</span>._stream(msgs, prefill<span class="op">=</span>prefill, max_tokens<span class="op">=</span>maxtok, system<span class="op">=</span>sp, temperature<span class="op">=</span>temp, <span class="op">**</span>kwargs)</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="va">self</span>.c.messages.create(model<span class="op">=</span><span class="va">self</span>.model, messages<span class="op">=</span>msgs, max_tokens<span class="op">=</span>maxtok, system<span class="op">=</span>sp, temperature<span class="op">=</span>temp, <span class="op">**</span>kwargs)</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>._log(res, prefill, msgs, maxtok, sp, temp, stream<span class="op">=</span>stream, stop<span class="op">=</span>stop, <span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="6dd255e0" class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> c(pr, sp<span class="op">=</span>sp, tools<span class="op">=</span>sums, tool_choice<span class="op">=</span>sums)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>ToolUseBlock(id=‘toolu_01KNbjuc8utt6ZroFngmAcuj’, input={‘a’: 604542, ‘b’: 6458932}, name=‘sums’, type=‘tool_use’)</p>
<details>
<ul>
<li>id: <code>msg_01T8zmguPksQaKLLgUuaYAJL</code></li>
<li>content: <code>[{'id': 'toolu_01KNbjuc8utt6ZroFngmAcuj', 'input': {'a': 604542, 'b': 6458932}, 'name': 'sums', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 438, 'output_tokens': 64, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<div id="f0bb426f" class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> mk_toolres(r, ns<span class="op">=</span>ns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L228" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="client.structured" class="level3">
<h3 class="anchored" data-anchor-id="client.structured">Client.structured</h3>
<blockquote class="blockquote">
<pre><code> Client.structured (msgs:list, tools:Optional[list]=None,
                    obj:Optional=None,
                    ns:Optional[collections.abc.Mapping]=None, sp='',
                    temp=0, maxtok=4096, prefill='', stream:bool=False,
                    stop=None, tool_choice:Optional[dict]=None,
                    metadata:MetadataParam|NotGiven=NOT_GIVEN,
                    stop_sequences:List[str]|NotGiven=NOT_GIVEN, system:Un
                    ion[str,Iterable[TextBlockParam]]|NotGiven=NOT_GIVEN,
                    temperature:float|NotGiven=NOT_GIVEN,
                    top_k:int|NotGiven=NOT_GIVEN,
                    top_p:float|NotGiven=NOT_GIVEN,
                    extra_headers:Headers|None=None,
                    extra_query:Query|None=None,
                    extra_body:Body|None=None,
                    timeout:float|httpx.Timeout|None|NotGiven=NOT_GIVEN)</code></pre>
</blockquote>
<p><em>Return the value of all tool calls (generally used for structured outputs)</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>msgs</td>
<td>list</td>
<td></td>
<td>List of messages in the dialog</td>
</tr>
<tr class="even">
<td>tools</td>
<td>Optional</td>
<td>None</td>
<td>List of tools to make available to Claude</td>
</tr>
<tr class="odd">
<td>obj</td>
<td>Optional</td>
<td>None</td>
<td>Class to search for tools</td>
</tr>
<tr class="even">
<td>ns</td>
<td>Optional</td>
<td>None</td>
<td>Namespace to search for tools</td>
</tr>
<tr class="odd">
<td>sp</td>
<td>str</td>
<td></td>
<td>The system prompt</td>
</tr>
<tr class="even">
<td>temp</td>
<td>int</td>
<td>0</td>
<td>Temperature</td>
</tr>
<tr class="odd">
<td>maxtok</td>
<td>int</td>
<td>4096</td>
<td>Maximum tokens</td>
</tr>
<tr class="even">
<td>prefill</td>
<td>str</td>
<td></td>
<td>Optional prefill to pass to Claude as start of its response</td>
</tr>
<tr class="odd">
<td>stream</td>
<td>bool</td>
<td>False</td>
<td>Stream response?</td>
</tr>
<tr class="even">
<td>stop</td>
<td>NoneType</td>
<td>None</td>
<td>Stop sequence</td>
</tr>
<tr class="odd">
<td>tool_choice</td>
<td>Optional</td>
<td>None</td>
<td>Optionally force use of some tool</td>
</tr>
<tr class="even">
<td>metadata</td>
<td>MetadataParam | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="odd">
<td>stop_sequences</td>
<td>List[str] | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="even">
<td>system</td>
<td>Union[str, Iterable[TextBlockParam]] | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="odd">
<td>temperature</td>
<td>float | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="even">
<td>top_k</td>
<td>int | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="odd">
<td>top_p</td>
<td>float | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
<tr class="even">
<td>extra_headers</td>
<td>Headers | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>extra_query</td>
<td>Query | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>extra_body</td>
<td>Body | None</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>timeout</td>
<td>float | httpx.Timeout | None | NotGiven</td>
<td>NOT_GIVEN</td>
<td></td>
</tr>
</tbody>
</table>
<div id="b3564424" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="at">@delegates</span>(Client.<span class="fu">__call__</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> structured(<span class="va">self</span>:Client,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>               msgs:<span class="bu">list</span>, <span class="co"># List of messages in the dialog</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>               tools:Optional[<span class="bu">list</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># List of tools to make available to Claude</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>               obj:Optional<span class="op">=</span><span class="va">None</span>, <span class="co"># Class to search for tools</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>               ns:Optional[abc.Mapping]<span class="op">=</span><span class="va">None</span>, <span class="co"># Namespace to search for tools</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>               <span class="op">**</span>kwargs):</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Return the value of all tool calls (generally used for structured outputs)"</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>    tools <span class="op">=</span> listify(tools)</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="va">self</span>(msgs, tools<span class="op">=</span>tools, tool_choice<span class="op">=</span>tools, <span class="op">**</span>kwargs)</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ns <span class="kw">is</span> <span class="va">None</span>: ns<span class="op">=</span>mk_ns(<span class="op">*</span>tools)</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> obj <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: ns <span class="op">=</span> mk_ns(obj)</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    cts <span class="op">=</span> <span class="bu">getattr</span>(res, <span class="st">'content'</span>, [])</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>    tcs <span class="op">=</span> [call_func(o.name, o.<span class="bu">input</span>, ns<span class="op">=</span>ns) <span class="cf">for</span> o <span class="kw">in</span> cts <span class="cf">if</span> <span class="bu">isinstance</span>(o,ToolUseBlock)]</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tcs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Anthropic’s API does not support response formats directly, so instead we provide a <code>structured</code> method to use tool calling to achieve the same result. The result of the tool is not passed back to Claude in this case, but instead is returned directly to the user.</p>
<div id="44d2cc82" class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>c.structured(pr, tools<span class="op">=</span>[sums])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>[7063474]</code></pre>
</div>
</div>
</section>
</section>
<section id="chat" class="level2">
<h2 class="anchored" data-anchor-id="chat">Chat</h2>
<p>Rather than manually adding the responses to a dialog, we’ll create a simple <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> class to do that for us, each time we make a request. We’ll also store the system prompt and tools here, to avoid passing them every time.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L244" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="chat-1" class="level3">
<h3 class="anchored" data-anchor-id="chat-1">Chat</h3>
<blockquote class="blockquote">
<pre><code> Chat (model:Optional[str]=None, cli:Optional[__main__.Client]=None,
       sp='', tools:Optional[list]=None, temp=0,
       cont_pr:Optional[str]=None)</code></pre>
</blockquote>
<p><em>Anthropic chat client.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>model</td>
<td>Optional</td>
<td>None</td>
<td>Model to use (leave empty if passing <code>cli</code>)</td>
</tr>
<tr class="even">
<td>cli</td>
<td>Optional</td>
<td>None</td>
<td>Client to use (leave empty if passing <code>model</code>)</td>
</tr>
<tr class="odd">
<td>sp</td>
<td>str</td>
<td></td>
<td>Optional system prompt</td>
</tr>
<tr class="even">
<td>tools</td>
<td>Optional</td>
<td>None</td>
<td>List of tools to make available to Claude</td>
</tr>
<tr class="odd">
<td>temp</td>
<td>int</td>
<td>0</td>
<td>Temperature</td>
</tr>
<tr class="even">
<td>cont_pr</td>
<td>Optional</td>
<td>None</td>
<td>User prompt to continue an assistant response: assistant,[user:“…”],assistant</td>
</tr>
</tbody>
</table>
<div id="a77d1edb" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Chat:</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>                 model:Optional[<span class="bu">str</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># Model to use (leave empty if passing `cli`)</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>                 cli:Optional[Client]<span class="op">=</span><span class="va">None</span>, <span class="co"># Client to use (leave empty if passing `model`)</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>                 sp<span class="op">=</span><span class="st">''</span>, <span class="co"># Optional system prompt</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>                 tools:Optional[<span class="bu">list</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># List of tools to make available to Claude</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>                 temp<span class="op">=</span><span class="dv">0</span>, <span class="co"># Temperature</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>                 cont_pr:Optional[<span class="bu">str</span>]<span class="op">=</span><span class="va">None</span>): <span class="co"># User prompt to continue an assistant response: assistant,[user:"..."],assistant</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Anthropic chat client."</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> model <span class="kw">or</span> cli</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> cont_pr <span class="op">!=</span> <span class="st">""</span>, <span class="st">"cont_pr may not be an empty string"</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.c <span class="op">=</span> (cli <span class="kw">or</span> Client(model))</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.h,<span class="va">self</span>.sp,<span class="va">self</span>.tools,<span class="va">self</span>.cont_pr,<span class="va">self</span>.temp <span class="op">=</span> [],sp,tools,cont_pr,temp</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> use(<span class="va">self</span>): <span class="cf">return</span> <span class="va">self</span>.c.use</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The class stores the <a href="https://claudette.answer.ai/core.html#client"><code>Client</code></a> that will provide the responses in <code>c</code>, and a history of messages in <code>h</code>.</p>
<div id="04b837c5" class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>sp <span class="op">=</span> <span class="st">"Never mention what tools you use."</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>chat.c.use, chat.h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(In: 0; Out: 0; Cache create: 0; Cache read: 0; Total: 0, [])</code></pre>
</div>
</div>
<p>We’ve shown the token usage but we really care about is pricing. Let’s extract the latest <a href="https://www.anthropic.com/pricing#anthropic-api">pricing</a> from Anthropic into a <code>pricing</code> dict.</p>
<p>We’ll patch <code>Usage</code> to enable it compute the cost given pricing.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L271" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="usage.cost" class="level3">
<h3 class="anchored" data-anchor-id="usage.cost">Usage.cost</h3>
<blockquote class="blockquote">
<pre><code> Usage.cost (costs:tuple)</code></pre>
</blockquote>
<div id="6bc3b816" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(<span class="va">self</span>:Usage, costs:<span class="bu">tuple</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    cache_w, cache_r <span class="op">=</span> <span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"cache_creation_input_tokens"</span>,<span class="dv">0</span>), <span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"cache_read_input_tokens"</span>,<span class="dv">0</span>)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>([<span class="va">self</span>.input_tokens <span class="op">*</span> costs[<span class="dv">0</span>] <span class="op">+</span>  <span class="va">self</span>.output_tokens <span class="op">*</span> costs[<span class="dv">1</span>] <span class="op">+</span>  cache_w <span class="op">*</span> costs[<span class="dv">2</span>] <span class="op">+</span> cache_r <span class="op">*</span> costs[<span class="dv">3</span>]]) <span class="op">/</span> <span class="fl">1e6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="10360d53" class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>chat.c.use.cost(pricing[model_types[chat.c.model]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.0</code></pre>
</div>
</div>
<p>This is clunky. Let’s add <code>cost</code> as a property for the <a href="https://claudette.answer.ai/core.html#chat"><code>Chat</code></a> class. It will pass in the appropriate prices for the current model to the usage cost calculator.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L277" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat.cost" class="level3">
<h3 class="anchored" data-anchor-id="chat.cost">Chat.cost</h3>
<blockquote class="blockquote">
<pre><code> Chat.cost ()</code></pre>
</blockquote>
<div id="aae25dd2" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(as_prop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cost(<span class="va">self</span>: Chat) <span class="op">-&gt;</span> <span class="bu">float</span>: <span class="cf">return</span> <span class="va">self</span>.c.use.cost(pricing[model_types[<span class="va">self</span>.c.model]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="8826fc8c" class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>chat.cost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.0</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L305" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="chat.__call__" class="level3">
<h3 class="anchored" data-anchor-id="chat.__call__">Chat.__call__</h3>
<blockquote class="blockquote">
<pre><code> Chat.__call__ (pr=None, temp=None, maxtok=4096, stream=False, prefill='',
                tool_choice:Optional[dict]=None, **kw)</code></pre>
</blockquote>
<p><em>Call self as a function.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>pr</td>
<td>NoneType</td>
<td>None</td>
<td>Prompt / message</td>
</tr>
<tr class="even">
<td>temp</td>
<td>NoneType</td>
<td>None</td>
<td>Temperature</td>
</tr>
<tr class="odd">
<td>maxtok</td>
<td>int</td>
<td>4096</td>
<td>Maximum tokens</td>
</tr>
<tr class="even">
<td>stream</td>
<td>bool</td>
<td>False</td>
<td>Stream response?</td>
</tr>
<tr class="odd">
<td>prefill</td>
<td>str</td>
<td></td>
<td>Optional prefill to pass to Claude as start of its response</td>
</tr>
<tr class="even">
<td>tool_choice</td>
<td>Optional</td>
<td>None</td>
<td>Optionally force use of some tool</td>
</tr>
<tr class="odd">
<td>kw</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div id="42a05df9" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _stream(<span class="va">self</span>:Chat, res):</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="cf">from</span> res</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.h <span class="op">+=</span> mk_toolres(<span class="va">self</span>.c.result, ns<span class="op">=</span><span class="va">self</span>.tools, obj<span class="op">=</span><span class="va">self</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="d0178ee1" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _post_pr(<span class="va">self</span>:Chat, pr, prev_role):</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> prev_role <span class="op">==</span> <span class="st">'assistant'</span>:</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.cont_pr <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Prompt must be given after assistant completion, or use `self.cont_pr`."</span>)</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>        pr <span class="op">=</span> <span class="va">self</span>.cont_pr <span class="co"># No user prompt, keep the chain</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr: <span class="va">self</span>.h.append(mk_msg(pr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="1b5c04e6" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _append_pr(<span class="va">self</span>:Chat,</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>               pr<span class="op">=</span><span class="va">None</span>,  <span class="co"># Prompt / message</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>              ):</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    prev_role <span class="op">=</span> nested_idx(<span class="va">self</span>.h, <span class="op">-</span><span class="dv">1</span>, <span class="st">'role'</span>) <span class="cf">if</span> <span class="va">self</span>.h <span class="cf">else</span> <span class="st">'assistant'</span> <span class="co"># First message should be 'user'</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pr <span class="kw">and</span> prev_role <span class="op">==</span> <span class="st">'user'</span>: <span class="va">self</span>() <span class="co"># already user request pending</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._post_pr(pr, prev_role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="bec85e37" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>:Chat,</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>             pr<span class="op">=</span><span class="va">None</span>,  <span class="co"># Prompt / message</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>             temp<span class="op">=</span><span class="va">None</span>, <span class="co"># Temperature</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>             maxtok<span class="op">=</span><span class="dv">4096</span>, <span class="co"># Maximum tokens</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>             stream<span class="op">=</span><span class="va">False</span>, <span class="co"># Stream response?</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>             prefill<span class="op">=</span><span class="st">''</span>, <span class="co"># Optional prefill to pass to Claude as start of its response</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>             tool_choice:Optional[<span class="bu">dict</span>]<span class="op">=</span><span class="va">None</span>, <span class="co"># Optionally force use of some tool</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>             <span class="op">**</span>kw):</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> temp <span class="kw">is</span> <span class="va">None</span>: temp<span class="op">=</span><span class="va">self</span>.temp</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._append_pr(pr)</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="va">self</span>.c(<span class="va">self</span>.h, stream<span class="op">=</span>stream, prefill<span class="op">=</span>prefill, sp<span class="op">=</span><span class="va">self</span>.sp, temp<span class="op">=</span>temp, maxtok<span class="op">=</span>maxtok,</span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>                 tools<span class="op">=</span><span class="va">self</span>.tools, tool_choice<span class="op">=</span>tool_choice,<span class="op">**</span>kw)</span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stream: <span class="cf">return</span> <span class="va">self</span>._stream(res)</span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.h <span class="op">+=</span> mk_toolres(<span class="va">self</span>.c.result, ns<span class="op">=</span><span class="va">self</span>.tools)</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>__call__</code> method just passes the request along to the <a href="https://claudette.answer.ai/core.html#client"><code>Client</code></a>, but rather than just passing in this one prompt, it appends it to the history and passes it all along. As a result, we now have state!</p>
<div id="cb393257" class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="40073f42" class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"I'm Jeremy"</span>)</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"What's my name?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Your name is Jeremy.</p>
<details>
<ul>
<li>id: <code>msg_01GpNv4P5x9Gzc5mxxw9FgEL</code></li>
<li>content: <code>[{'text': 'Your name is Jeremy.', 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 41, 'output_tokens': 9, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<div id="5457b51d" class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>chat.use, chat.cost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(In: 58; Out: 27; Cache create: 0; Cache read: 0; Total: 85, 0.000579)</code></pre>
</div>
</div>
<p>Let’s try out prefill too:</p>
<div id="20a32de0" class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> <span class="st">"Concisely, what is the meaning of life?"</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>pref <span class="op">=</span> <span class="st">'According to Douglas Adams,'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9b28705d" class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>chat(q, prefill<span class="op">=</span>pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>According to Douglas Adams,42. But seriously: To find purpose, create meaning, love, grow, and make a positive impact while experiencing life’s journey.</p>
<details>
<ul>
<li>id: <code>msg_011s2iLranbHFhdsVg8sz6eY</code></li>
<li>content: <code>[{'text': "According to Douglas Adams,42. But seriously: To find purpose, create meaning, love, grow, and make a positive impact while experiencing life's journey.", 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 69, 'output_tokens': 32, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<p>By default messages must be in user, assistant, user format. If this isn’t followed (aka calling <code>chat()</code> without a user message) it will error out:</p>
<div id="c3761928" class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: chat()</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e: <span class="bu">print</span>(<span class="st">"Error:"</span>, e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error: Prompt must be given after assistant completion, or use `self.cont_pr`.</code></pre>
</div>
</div>
<p>Setting <code>cont_pr</code> allows a “default prompt” to be specified when a prompt isn’t specified. Usually used to prompt the model to continue.</p>
<div id="54c5a2bc" class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>chat.cont_pr <span class="op">=</span> <span class="st">"keep going..."</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>chat()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>To build meaningful relationships, pursue passions, learn continuously, help others, appreciate beauty, overcome challenges, leave a positive legacy, and find personal fulfillment through whatever brings you joy and contributes to the greater good.</p>
<details>
<ul>
<li>id: <code>msg_01Rz8oydLAinmSMyaKbmmpE9</code></li>
<li>content: <code>[{'text': 'To build meaningful relationships, pursue passions, learn continuously, help others, appreciate beauty, overcome challenges, leave a positive legacy, and find personal fulfillment through whatever brings you joy and contributes to the greater good.', 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 105, 'output_tokens': 54, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<p>We can also use streaming:</p>
<div id="529104ec" class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> chat(<span class="st">"I'm Jeremy"</span>, stream<span class="op">=</span><span class="va">True</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hello Jeremy! Nice to meet you. How are you today?</code></pre>
</div>
</div>
<div id="14abb3dc" class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> chat(q, prefill<span class="op">=</span>pref, stream<span class="op">=</span><span class="va">True</span>): <span class="bu">print</span>(o, end<span class="op">=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>According to Douglas Adams,  42. More seriously: to find purpose, love, grow, and make a positive impact while experiencing life's journey.</code></pre>
</div>
</div>
</section>
<section id="chat-tool-use" class="level3">
<h3 class="anchored" data-anchor-id="chat-tool-use">Chat tool use</h3>
<p>We automagically get streamlined tool use as well:</p>
<div id="ee6535cf" class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>pr <span class="op">=</span> <span class="ss">f"What is </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">+</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">?"</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>pr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'What is 604542+6458932?'</code></pre>
</div>
</div>
<div id="797741c5" class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, sp<span class="op">=</span>sp, tools<span class="op">=</span>[sums])</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(pr)</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finding the sum of 604542 and 6458932</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>Let me calculate that sum for you.</p>
<details>
<ul>
<li>id: <code>msg_01MY2VWnZuU8jKyRKJ5FGzmM</code></li>
<li>content: <code>[{'text': 'Let me calculate that sum for you.', 'type': 'text'}, {'id': 'toolu_01JXnJ1ReFqx5ppX3y7UcQCB', 'input': {'a': 604542, 'b': 6458932}, 'name': 'sums', 'type': 'tool_use'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>tool_use</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 437, 'output_tokens': 87, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<p>Now we need to send this result to Claude—calling the object with no parameters tells it to return the tool result to Claude:</p>
<div id="0979c832" class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>chat()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>604542 + 6458932 = 7063474</p>
<details>
<ul>
<li>id: <code>msg_01Sog8j3pgYb3TBWPYwR4uQU</code></li>
<li>content: <code>[{'text': '604542 + 6458932 = 7063474', 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 532, 'output_tokens': 22, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<p>It should be correct, because it actually used our Python function to do the addition. Let’s check:</p>
<div id="b7ff0879" class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>a<span class="op">+</span>b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>7063474</code></pre>
</div>
</div>
</section>
</section>
<section id="images" class="level2">
<h2 class="anchored" data-anchor-id="images">Images</h2>
<p>Claude can handle image data as well. As everyone knows, when testing image APIs you have to use a cute puppy.</p>
<div id="5d35d564" class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Image is Cute_dog.jpg from Wikimedia</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>fn <span class="op">=</span> Path(<span class="st">'samples/puppy.jpg'</span>)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>display.Image(filename<span class="op">=</span>fn, width<span class="op">=</span><span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-113-output-1.jpeg" class="img-fluid figure-img" width="200"></p>
</figure>
</div>
</div>
</div>
<div id="d120d8fb" class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> fn.read_bytes()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9fd16299" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _add_cache(d, cache):</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Optionally add cache control"</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cache: d[<span class="st">"cache_control"</span>] <span class="op">=</span> {<span class="st">"type"</span>: <span class="st">"ephemeral"</span>}</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Claude supports context caching by adding a <code>cache_control</code> header, so we provide an option to enable that.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L328" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="img_msg" class="level3">
<h3 class="anchored" data-anchor-id="img_msg">img_msg</h3>
<blockquote class="blockquote">
<pre><code> img_msg (data:bytes, cache=False)</code></pre>
</blockquote>
<p><em>Convert image <code>data</code> into an encoded <code>dict</code></em></p>
<div id="af0c7392" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> img_msg(data:<span class="bu">bytes</span>, cache<span class="op">=</span><span class="va">False</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert image `data` into an encoded `dict`"</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> base64.b64encode(data).decode(<span class="st">"utf-8"</span>)</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    mtype <span class="op">=</span> mimetypes.types_map[<span class="st">'.'</span><span class="op">+</span>imghdr.what(<span class="va">None</span>, h<span class="op">=</span>data)]</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">type</span><span class="op">=</span><span class="st">"base64"</span>, media_type<span class="op">=</span>mtype, data<span class="op">=</span>img)</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _add_cache({<span class="st">"type"</span>: <span class="st">"image"</span>, <span class="st">"source"</span>: r}, cache)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Anthropic have documented the particular <code>dict</code> structure that expect image data to be in, so we have a little function to create that for us.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L336" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="text_msg" class="level3">
<h3 class="anchored" data-anchor-id="text_msg">text_msg</h3>
<blockquote class="blockquote">
<pre><code> text_msg (s:str, cache=False)</code></pre>
</blockquote>
<p><em>Convert <code>s</code> to a text message</em></p>
<div id="07b3340d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> text_msg(s:<span class="bu">str</span>, cache<span class="op">=</span><span class="va">False</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert `s` to a text message"</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _add_cache({<span class="st">"type"</span>: <span class="st">"text"</span>, <span class="st">"text"</span>: s}, cache)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A Claude message can be a list of image and text parts. So we’ve also created a helper for making the text parts.</p>
<div id="0c0eed5d" class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> <span class="st">"In brief, what color flowers are in this image?"</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([img_msg(img), text_msg(q)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2295c2d3" class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>c([msg])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>In this adorable puppy photo, there are purple/lavender colored flowers (appears to be asters or similar daisy-like flowers) in the background.</p>
<details>
<ul>
<li>id: <code>msg_01Ej9XSFQKFtD9pUns5g7tom</code></li>
<li>content: <code>[{'text': 'In this adorable puppy photo, there are purple/lavender colored flowers (appears to be asters or similar daisy-like flowers) in the background.', 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 110, 'output_tokens': 44, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<div id="197593b3" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mk_content(src, cache<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create appropriate content data structure based on type of content"</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(src,<span class="bu">str</span>): <span class="cf">return</span> text_msg(src, cache<span class="op">=</span>cache)</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(src,<span class="bu">bytes</span>): <span class="cf">return</span> img_msg(src, cache<span class="op">=</span>cache)</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(src, abc.Mapping): <span class="cf">return</span> {k:_str_if_needed(v) <span class="cf">for</span> k,v <span class="kw">in</span> src.items()}</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _str_if_needed(src)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>There’s not need to manually choose the type of message, since we figure that out from the data of the source data.</p>
<div id="6ccff61c" class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>_mk_content(<span class="st">'Hi'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'type': 'text', 'text': 'Hi'}</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/claudette/blob/main/claudette/core.py#L349" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msg" class="level3">
<h3 class="anchored" data-anchor-id="mk_msg">mk_msg</h3>
<blockquote class="blockquote">
<pre><code> mk_msg (content, role='user', cache=False, **kw)</code></pre>
</blockquote>
<p><em>Helper to create a <code>dict</code> appropriate for a Claude message. <code>kw</code> are added as key/value pairs to the message</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>content</td>
<td></td>
<td></td>
<td>A string, list, or dict containing the contents of the message</td>
</tr>
<tr class="even">
<td>role</td>
<td>str</td>
<td>user</td>
<td>Must be ‘user’ or ‘assistant’</td>
</tr>
<tr class="odd">
<td>cache</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr class="even">
<td>kw</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div id="a33731ba" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msg(content, <span class="co"># A string, list, or dict containing the contents of the message</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>           role<span class="op">=</span><span class="st">'user'</span>, <span class="co"># Must be 'user' or 'assistant'</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>           cache<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>           <span class="op">**</span>kw):</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper to create a `dict` appropriate for a Claude message. `kw` are added as key/value pairs to the message"</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(content, <span class="st">'content'</span>): content,role <span class="op">=</span> content.content,content.role</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(content, abc.Mapping): content<span class="op">=</span>content.get(<span class="st">'content'</span>, content)</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(content, <span class="bu">list</span>): content<span class="op">=</span>[content]</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> [_mk_content(o, cache <span class="cf">if</span> islast <span class="cf">else</span> <span class="va">False</span>) <span class="cf">for</span> islast,o <span class="kw">in</span> loop_last(content)] <span class="cf">if</span> content <span class="cf">else</span> <span class="st">'.'</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dict2obj(<span class="bu">dict</span>(role<span class="op">=</span>role, content<span class="op">=</span>content, <span class="op">**</span>kw), list_func<span class="op">=</span><span class="bu">list</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="19a9d3e1" class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>mk_msg([<span class="st">'hi'</span>, <span class="st">'there'</span>], cache<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb171"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="er">'content'</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span><span class="er">'text'</span><span class="fu">:</span> <span class="er">'hi'</span><span class="fu">,</span> <span class="er">'type'</span><span class="fu">:</span> <span class="er">'text'</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>               <span class="fu">{</span> <span class="er">'cache_control'</span><span class="fu">:</span> <span class="fu">{</span><span class="er">'type'</span><span class="fu">:</span> <span class="er">'ephemeral'</span><span class="fu">},</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'text'</span><span class="fu">:</span> <span class="er">'there'</span><span class="fu">,</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'type'</span><span class="fu">:</span> <span class="er">'text'</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="er">'role'</span><span class="fu">:</span> <span class="er">'user'</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="dfd1c8a6" class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> mk_msg([<span class="st">'hi'</span>, <span class="st">'there'</span>], cache<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we construct a message, we now use <a href="https://claudette.answer.ai/core.html#_mk_content"><code>_mk_content</code></a> to create the appropriate parts. Since a dialog contains multiple messages, and a message can contain multiple content parts, to pass a single message with multiple parts we have to use a list containing a single list:</p>
<div id="4f2ea0d4" class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>c([[img, q]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>In this adorable puppy photo, there are purple/lavender colored flowers (appears to be asters or similar daisy-like flowers) in the background.</p>
<details>
<ul>
<li>id: <code>msg_014GQfAQF5FYU8a4Y8bvVm16</code></li>
<li>content: <code>[{'text': 'In this adorable puppy photo, there are purple/lavender colored flowers (appears to be asters or similar daisy-like flowers) in the background.', 'type': 'text'}]</code></li>
<li>model: <code>claude-3-5-sonnet-20241022</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 110, 'output_tokens': 38, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}</code></li>
</ul>
</details>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>As promised (much!) earlier, we’ve now finally completed our definition of <a href="https://claudette.answer.ai/core.html#mk_msg"><code>mk_msg</code></a>, and this version is the one we export to the Python module.</p>
</div>
</div>
<p>Some models unfortunately do not support image inputs such as Haiku 3.5</p>
<div id="df00fd6e" class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> models[<span class="op">-</span><span class="dv">1</span>]<span class="op">;</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'claude-3-5-haiku-20241022'</code></pre>
</div>
</div>
<div id="a58c57f9" class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> Client(model)</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>c([[img, q]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AssertionError</span>                            Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[115], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> c <span style="color:rgb(98,98,98)">=</span> Client(model)
<span class="ansi-green-fg">----&gt; 2</span> <span class="ansi-yellow-bg">c</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">img</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">q</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>

Cell <span class="ansi-green-fg">In[72], line 19</span>, in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, msgs, sp, temp, maxtok, prefill, stream, stop, tools, tool_choice, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     17</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> tool_choice: kwargs[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">tool_choice</span><span style="color:rgb(175,0,0)">'</span>] <span style="color:rgb(98,98,98)">=</span> mk_tool_choice(tool_choice)
<span class="ansi-green-fg ansi-bold">     18</span> msgs <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_precall(msgs, prefill, stop, kwargs)
<span class="ansi-green-fg">---&gt; 19</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">any</span>(t <span style="color:rgb(98,98,98)">==</span> <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">image</span><span style="color:rgb(175,0,0)">'</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> t <span style="font-weight:bold;color:rgb(175,0,255)">in</span> get_types(msgs)): <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>text_only, <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Images are not supported by the current model type: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>model<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">     20</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> stream: <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_stream(msgs, prefill<span style="color:rgb(98,98,98)">=</span>prefill, max_tokens<span style="color:rgb(98,98,98)">=</span>maxtok, system<span style="color:rgb(98,98,98)">=</span>sp, temperature<span style="color:rgb(98,98,98)">=</span>temp, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg ansi-bold">     21</span> res <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>c<span style="color:rgb(98,98,98)">.</span>messages<span style="color:rgb(98,98,98)">.</span>create(model<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>model, messages<span style="color:rgb(98,98,98)">=</span>msgs, max_tokens<span style="color:rgb(98,98,98)">=</span>maxtok, system<span style="color:rgb(98,98,98)">=</span>sp, temperature<span style="color:rgb(98,98,98)">=</span>temp, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)

<span class="ansi-red-fg">AssertionError</span>: Images are not supported by the current model type: claude-3-5-haiku-20241022</pre>
</div>
</div>
</div>
</section>
</section>
<section id="third-party-providers" class="level2">
<h2 class="anchored" data-anchor-id="third-party-providers">Third party providers</h2>
<section id="amazon-bedrock" class="level3">
<h3 class="anchored" data-anchor-id="amazon-bedrock">Amazon Bedrock</h3>
<p>These are Amazon’s current Claude models:</p>
<div id="81d16826" class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>models_aws</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['anthropic.claude-3-opus-20240229-v1:0',
 'anthropic.claude-3-5-sonnet-20241022-v2:0',
 'anthropic.claude-3-sonnet-20240229-v1:0',
 'anthropic.claude-3-haiku-20240307-v1:0']</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>anthropic</code> at version 0.34.2 seems not to install <code>boto3</code> as a dependency. You may need to do a <code>pip install boto3</code> or the creation of the <a href="https://claudette.answer.ai/core.html#client"><code>Client</code></a> below fails.</p>
</div>
</div>
<p>Provided <code>boto3</code> is installed, we otherwise don’t need any extra code to support Amazon Bedrock – we just have to set up the approach client:</p>
<div id="5fd151fe" class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>ab <span class="op">=</span> AnthropicBedrock(</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    aws_access_key<span class="op">=</span>os.environ[<span class="st">'AWS_ACCESS_KEY'</span>],</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    aws_secret_key<span class="op">=</span>os.environ[<span class="st">'AWS_SECRET_KEY'</span>],</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Client(models_aws[<span class="op">-</span><span class="dv">1</span>], ab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f1f2f214" class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(cli<span class="op">=</span>client)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ec54a422" class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"I'm Jeremy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p>It’s nice to meet you, Jeremy! I’m Claude, an AI assistant created by Anthropic. How can I help you today?</p>
<details>
<ul>
<li>id: <code>msg_bdrk_01JPBwsACbf1HZoNDUzbHNpJ</code></li>
<li>content: <code>[{'text': "It's nice to meet you, Jeremy! I'm Claude, an AI assistant created by Anthropic. How can I help you today?", 'type': 'text'}]</code></li>
<li>model: <code>claude-3-haiku-20240307</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'input_tokens': 10, 'output_tokens': 32}</code></li>
</ul>
</details>
</div>
</div>
</section>
<section id="google-vertex" class="level3">
<h3 class="anchored" data-anchor-id="google-vertex">Google Vertex</h3>
<div id="fdb46839" class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>models_goog</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['claude-3-opus@20240229',
 'claude-3-5-sonnet-v2@20241022',
 'claude-3-sonnet@20240229',
 'claude-3-haiku@20240307']</code></pre>
</div>
</div>
<div id="30921ab4" class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> anthropic <span class="im">import</span> AnthropicVertex</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> google.auth</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c00ef664" class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>project_id <span class="op">=</span> google.auth.default()[<span class="dv">1</span>]</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>region <span class="op">=</span> <span class="st">"us-east5"</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>gv <span class="op">=</span> AnthropicVertex(project_id<span class="op">=</span>project_id, region<span class="op">=</span>region)</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Client(models_goog[<span class="op">-</span><span class="dv">1</span>], gv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7d0481b5" class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(cli<span class="op">=</span>client)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="11006ae0" class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"I'm Jeremy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/claudette\.answer\.ai\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/AnswerDotAI/claudette/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>